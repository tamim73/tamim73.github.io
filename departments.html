<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>departments</title>
    <!-- font awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU"
        crossorigin="anonymous">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <!-- .................................................. -->
    <!-- navbar -->
    <nav class=" navbar fixed-top navbar-expand-sm navbar-dark bg-dark mb-1 ">
            <div class="container">
                    <a class="navbar-brand" href="#">Training</a>
                    <button class="navbar-toggler" data-toggle="collapse" data-target="#navbarNav">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div id="navbarNav" class="collapse navbar-collapse">
                        <ul class="navbar-nav ml-auto">
                            <li class="nav-item">
                                <a class="nav-link text-white" href="departments.html">Departments</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-white" href="employees.html">Employees</a>
                            </li>
                            <li class="nav-item">
                                <a id="logincorner" class="nav-link" href="index.html">signout</a>
                            </li>
                        </ul>
                    </div>
                </div>
    </nav>

    <!-- main body -->
    <div class=" main ">
        
                <div class="container-d ">
                    <h2 class="mb-5 p-3">Departments</h2>
                    <!-- actions -->
                    <div id="actions" class="mb-3">

                        <div class="row">
                            <div class="col-md-5">
                                <a href="#" class="btn btn-success btn-block" data-toggle="modal" data-target="#addDepModal">
                                    <i class="fas fa-plus"></i> Add department
                                </a>
                            </div>
                        </div>
                    </div>
                    <!-- table -->
                    <table class="table table-bordered table-hover text-center">
                        <thead class="thead-dark">
                            <tr>
                                <th>ID</th>
                                <th>Department Name</th>
                                <th>Description</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="depTable">


                        </tbody>
                    </table>
                    <div id="alert" class="alert alert-success text-center">

                    </div>
               
        </div>
    </div>

    <!-- footer -->
    <footer class="bg-dark fixed-bottom text-white mt-1 p-1 ">
        <div class="container ">
            <p class="text-center text-muted">
                Copyright ©
                <span id="year">2018</span>
                tamim
            </p>
        </div>
    </footer>


    <!-- modals -->
    <!-- add dep modal -->
    <div class="modal" id="addDepModal" style="display: none;" data-backdrop="static" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">add department</h5>
                    <button class="close" data-dismiss="modal">×</button>
                </div>
                <div class="modal-body">
                    <!--  body -->
                    <form>

                        <!-- deparment name -->
                        <div class="form-group">
                            <label for="newDepName">Department Name</label>
                            <input id="newDepName" class="form-control form-control-lg" type="text" id="depName"
                                placeholder="Enter department name">
                            <div class="invalid-feedback">
                                Enter a valid name
                            </div>
                        </div>

                        <!-- TEXTAREA department descreption -->
                        <div class="form-group">
                            <label for="depMsg">Description</label>
                            <textarea id="newDepNotes" class="form-control" id="depMsg" placeholder="Enter department description"
                                rows="3"></textarea>
                        </div>


                    </form>
                    <!--  -->
                </div>
                <div class="modal-footer">
                    <button id="buAddDep" class="btn btn-primary btn-block">Submit</button>

                </div>
            </div>
        </div>
    </div>
    <!-- update dep modal -->
    <div class="modal" id="updateDepModal" style="display: none;" data-backdrop="static" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="updateDepHeader" class="modal-title">Update department</h5>
                    <button class="close" data-dismiss="modal">×</button>
                </div>
                <div class="modal-body">
                    <!--  body -->
                    <form>

                        <!-- deparment name -->
                        <div class="form-group">
                            <label for="updateName">Department Name</label>
                            <input id="updateDepName" class="form-control form-control-lg" type="text" id="depName"
                                placeholder="Enter department name">
                            <div class="invalid-feedback">
                                Enter a valid name
                            </div>
                        </div>

                        <!-- TEXTAREA department descreption -->
                        <div class="form-group">
                            <label for="depMsg">Description</label>
                            <textarea id="updateDepNotes" class="form-control" id="depMsg" placeholder="Enter department description"
                                rows="3"></textarea>
                        </div>


                    </form>
                    <!--  -->
                </div>
                <div class="modal-footer">
                    <button id="buUpdateDep" class="btn btn-primary btn-block">Submit</button>

                </div>
            </div>
        </div>
    </div>
    <!-- delete dep modal -->
    <div class="modal" id="delDepModal" style="padding-right: 15px; display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="depNameHeader" class="modal-title">Delete {department name}</h5>
                    <button class="close" data-dismiss="modal">×</button>
                </div>
                <div id="delBody" class="modal-body">
                    Are you sure you want to delete this department?
                </div>
                <div class="modal-footer">
                    <button id="buDelDepRow" class="btn btn-danger">DELETE</button>
                </div>
            </div>
        </div>
    </div>


    <!-- .................................................. -->
    <!-- Bootstarp && jQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>

    <!-- my script -->
    <!-- <script type="text/javascript" src="script.js"></script> -->
    <script>
        // tabe
        var depTable = document.getElementById("depTable");
        // buttons
        var buAddDep = document.getElementById('buAddDep');
        var buDelDepRow = document.getElementById('buDelDepRow');
        var buUpdateDep = document.getElementById('buUpdateDep')
        // divs
        delBody = document.getElementById('delBody');
        var alert = document.getElementById('alert');
        // inputs
        var newDepName = document.getElementById('newDepName');
        var newDepNotes = document.getElementById('newDepNotes');
        var updateDepName = document.getElementById('updateDepName');
        var updateDepNotes = document.getElementById('updateDepNotes');

        alert.style.display = 'none';

        let currentRowIndex = null;
        let currentDepName = null;
        function addRowDep(obj) {
            var row = depTable.insertRow();
            var idCell = row.insertCell(0);
            var nameCell = row.insertCell(1);
            var notesCell = row.insertCell(2);
            var optionsCell = row.insertCell(3);


            idCell.innerHTML = obj.id;
            nameCell.innerHTML = obj.name;
            notesCell.innerHTML = obj.notes;
            optionsCell.innerHTML = ' <div class="row">\
                                        <div class="col-md-6 text-warning " ><i onclick="showUpdateModal(this)" class="pointer fas fa-edit"></i> </div>\
                                        <div class="col-md-6 text-danger "  ><i onclick="showDelModal(this)"  class="pointer fas fa-trash"></i> </div>\
                                    </div>';
        }



        // ! add ----------------------------------

        buAddDep.onclick = async function () {

            if (newDepName.value != "") {
                let newDep = {

                    name: newDepName.value,
                    notes: newDepNotes.value

                }

                const response = await fetch('https://trainingg.herokuapp.com/deps', {
                    method: 'post',
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(newDep)

                })
                const st = await response.status;
                const data = await response.json();
                console.log(st);
                console.log(data);

                if (st === 200) {
                    alert.style.display = 'block';
                    alert.classList.add('alert-success')
                    alert.innerHTML = 'department added'
                } else {
                    alert.style.display = 'block';
                    alert.classList.add('alert-danger')
                    alert.innerHTML = 'unable to add department'
                }



                refresh();
                $('#addDepModal').modal('hide');

            } else {
                newDepName.classList.add('is-invalid')
            }


        }


        //! update --------------------------------

        async function showUpdateModal(elem) {
            currentRowIndex = $(elem).parent().parent().parent().parent().index();
            currentDepId = depTable.rows[currentRowIndex].cells[0].innerText;
            currentDepName = depTable.rows[currentRowIndex].cells[1].innerText;

            const response = await fetch('https://trainingg.herokuapp.com/deps/' + currentDepId);
            const data = await response.json();
            updateDepName.value = data.name;
            updateDepNotes.value = data.notes;
            document.getElementById('depNameHeader').innerHTML = 'Delete ' + currentDepName + ' ?';


            $('#updateDepModal').modal('show');

            document.getElementById('updateDepHeader').innerHTML = 'Update ' + currentDepName + ' ?';

        }


        buUpdateDep.onclick = async function () {

            if (updateDepName.value != "") {
                let updatedDep = {

                    name: updateDepName.value,
                    notes: updateDepNotes.value

                }

                const response = await fetch('https://trainingg.herokuapp.com/deps/' + currentDepId, {
                    method: 'put',
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updatedDep)

                })
                const st = await response.status;
                const data = await response.json();
                console.log(st);
                console.log(data);

                if (st === 200) {
                    alert.style.display = 'block';
                    alert.classList.add('alert-success')
                    alert.innerHTML = 'department updated'
                } else {
                    alert.style.display = 'block';
                    alert.classList.add('alert-danger')
                    alert.innerHTML = 'unable to update department'
                }



                refresh();
                $('#updateDepModal').modal('hide');

            } else {
                updateDepName.classList.add('is-invalid')
            }


        }


        //! delete --------------------------------
        async function showDelModal(elem) {


            const response = await fetch('https://trainingg.herokuapp.com/emps/all');
            const data = await response.json();
            currentRowIndex = $(elem).parent().parent().parent().parent().index();
            currentDepId = depTable.rows[currentRowIndex].cells[0].innerText;
            currentDepName = depTable.rows[currentRowIndex].cells[1].innerText;
            let arrEmpIds = [];
            for (let i = 0; i < data.length; i++) {
                arrEmpIds.push(data[i].depid);
            }
            document.getElementById('depNameHeader').innerHTML = 'Delete ' + currentDepName + ' ?';
            console.log(arrEmpIds);
            console.log(arrEmpIds.includes(parseInt(currentDepId)));
            if (arrEmpIds.includes(parseInt(currentDepId))) {
                buDelDepRow.disabled = true;
                delBody.innerHTML = "you cant delete this department because it has one or more employees, please delete all employees in this department then try again";
                document.getElementById('depNameHeader').innerHTML = 'Unable to delete ' + currentDepName + ' ?';
            }
            $('#delDepModal').modal('show');



        }

        buDelDepRow.onclick = function () {

            fetch('https://trainingg.herokuapp.com/deps/' + currentDepId, {
                method: 'delete',
            })
                .then(res => {
                    res.json()
                    console.log(res.status)
                    if (res.status === 200) {
                        alert.style.display = 'block';
                        alert.classList.add('alert-success')
                        alert.innerHTML = 'department deleted'
                    } else {
                        alert.style.display = 'block';
                        alert.classList.add('alert-danger')
                        alert.innerHTML = 'unable to delete department'
                    }
                })

            depTable.deleteRow(currentRowIndex);
            currentRowIndex = null;
            currentDepId = null;
            currentDepName = null;
            $('#delDepModal').modal('hide');
        };



        // on hide ---------------------------------

        $('#updateDepModal').on('hide.bs.modal', function (e) {
            updateDepName.value = "";
            updateDepNotes.value = "";
            buDelDepRow.disabled = false;
            delBody.innerHTML = "Are you sure you want to delete this department?";

            setTimeout(() => {
                alert.style.display = 'none';
                alert.classList.remove('alert-success')
                alert.classList.remove('alert-danger')
                alert.innerHTML = ''
            }, 3000);
        })

        $('#addDepModal').on('hide.bs.modal', function (e) {
            newDepName.value = "";
            newDepNotes.value = "";
            setTimeout(() => {
                alert.style.display = 'none';
                alert.classList.remove('alert-success')
                alert.classList.remove('alert-danger')
                alert.innerHTML = ''
            }, 3000);
        })


        $('#delDepModal').on('hide.bs.modal', function (e) {
            setTimeout(() => {
                alert.style.display = 'none';
                alert.classList.remove('alert-success')
                alert.classList.remove('alert-danger')
                alert.innerHTML = ''
            }, 3000);
        })




        // refresh----------------------------===


        function refresh() {
            fetch('https://trainingg.herokuapp.com/deps/all')
                .then(res => res.json())
                .then(data => {
                    console.log(data);
                    $("#depTable  tr").remove();
                    revData = data//.reverse()
                    for (let i = 0; i < data.length; i++) {
                        addRowDep(revData[i]);
                    }

                })
        }
        refresh()
    </script>
</body>

</html>